<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>TECSAFE Demo</title>
    <style>
      body {
        background: #0b7285;
        color: #ffffff;
      }

      button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        background: #1098ad;
        color: #ffffff;
      }

      select {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        background: #1098ad;
        color: #ffffff;
      }
    </style>
  </head>
  <body>
    <h1>Product</h1>
    <div id="product-widget"></div>
    <h1>Cart</h1>
    <div id="cart-widget"></div>
    <button id="destroy">Destroy</button>

    <h1>Global</h1>

    <select id="api-return">
      <option selected value="change">Change User</option>
      <option selected value="refresh">Refresh Token</option>
      <option value="invalid">Null Token</option>
      <option value="error">Error</option>
    </select>
    <button id="token">Force Reload Token</button>
    <button id="open">Open App</button>

    <script src="../dist/bundle.js"></script>
  </body>
  <script type="module">
    const apiReturnElement = document.getElementById("api-return");
    let user = 1;

    console.log(apiReturnElement.value);

    const api = await TecsafeSdk.initializeTecsafeApi(async () => {
      console.log("reload token");

      if (apiReturnElement.value === "change") {
        return dummyJwtToken(++user);
      }

      if (apiReturnElement.value === "refresh") {
        return dummyJwtToken(user);
      }

      if (apiReturnElement.value === "invalid") {
        return null;
      }

      if (apiReturnElement.value === "error") {
        throw Error("error");
      }
    });

    const cartWidgetWrapper = document.getElementById("cart-widget");
    const productWidgetWrapper = document.getElementById("product-widget");
    const tokenButton = document.getElementById("token");
    const destroyButton = document.getElementById("destroy");
    const openAppButton = document.getElementById("open");

    const cartWidget = api.cartWidget(cartWidgetWrapper);
    const productWidget = api.productDetailWidget(productWidgetWrapper);

    destroyButton.addEventListener("click", () => {
      cartWidget.destroy();
    });

    tokenButton.addEventListener("click", () => {
      api.reloadToken();
    });

    openAppButton.addEventListener("click", () => {
      api.openApp();
    });

    function dummyJwtToken(userId) {
      const payload = {
        sub: userId,
        exp: new Date().getTime() / 1000 + 60,
      };

      return `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.${btoa(
        JSON.stringify(payload),
      )}.signature`;
    }
  </script>
</html>
